<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSQ-60 互動問卷 (七點量表版)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --border-color: #dee2e6;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
            
            --adaptive-color: #2ecc71;
            --adaptive-bg: rgba(46, 204, 113, 0.15);
            --affect-regulating-color: #3498db;
            --affect-regulating-bg: rgba(52, 152, 219, 0.15);
            --image-distorting-color: #e74c3c;
            --image-distorting-bg: rgba(231, 76, 60, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 25px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        h1, h2, h3 {
            color: var(--dark-gray);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 1.5em;
        }
        h1 {
            text-align: center;
            border-bottom: none;
            font-size: 2em;
            margin-bottom: 0.5em;
        }
        
        #personal-info {
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        #personal-info label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        #name {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }

        .instructions {
            background-color: #e9f7fd;
            border-left: 5px solid var(--primary-color);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .scale-description {
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
            padding: 10px;
            background-color: var(--light-gray);
            border-radius: 5px;
        }

        .question-item {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        .question-item.unanswered {
            border-color: var(--danger-color);
            background-color: #fff9f9;
        }

        .question-text {
            font-weight: 500;
            margin-bottom: 15px;
        }

        .options-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .options-container label {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 8px 2px;
            margin: 0 1px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: bold;
            min-width: 30px;
        }

        .options-container input[type="radio"] {
            margin-bottom: 5px;
            accent-color: var(--primary-color); 
        }

        .options-container label:hover {
            background-color: #e9ecef;
            border-color: var(--secondary-color);
        }

        .options-container input[type="radio"]:checked + span {
            /* This is a placeholder, the styling is on the label parent */
        }
        
        .options-container label.selected {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }

        .btn {
            display: inline-block;
            font-weight: 400;
            color: #fff;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            background-color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 10px 20px;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: 0.25rem;
            transition: all 0.15s ease-in-out;
            text-decoration: none;
            margin: 5px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        #error-message {
            color: var(--danger-color);
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            display: none;
        }

        #results {
            display: none;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }

        .result-style {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
        }
        .result-style:nth-child(2) { background-color: var(--adaptive-bg); border-left: 5px solid var(--adaptive-color); }
        .result-style:nth-child(3) { background-color: var(--affect-regulating-bg); border-left: 5px solid var(--affect-regulating-color); }
        .result-style:nth-child(4) { background-color: var(--image-distorting-bg); border-left: 5px solid var(--image-distorting-color); }

        .result-style h3 {
            border-bottom: none;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .result-style:nth-child(2) h3 { color: var(--adaptive-color); }
        .result-style:nth-child(3) h3 { color: var(--affect-regulating-color); }
        .result-style:nth-child(4) h3 { color: var(--image-distorting-color); }

        .style-score {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .chart-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .export-buttons {
            text-align: center;
            margin-top: 30px;
        }
                
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            text-align: center;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover, .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* PDF Cover Page (hidden) */
        #pdf-cover-page {
            display: none;
            width: 800px;
            padding: 40px;
            background: #fff;
        }
        #pdf-cover-page h1 { font-size: 3em; }
        #pdf-cover-page p { font-size: 1.2em; }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            h1 { font-size: 1.6em; }
            .btn { width: 100%; box-sizing: border-box; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>DSQ-60 互動問卷 (七點量表版)</h1>

        <div id="personal-info">
            <label for="name">姓名</label>
            <input type="text" id="name" placeholder="請輸入您的姓名或暱稱">
        </div>

        <div class="instructions">
            <p>本問卷旨在了解個人對自己的看法。請根據以下七點量表，指出每個項目在多大程度上適用於你。</p>
        </div>
        
        <div class="scale-description">
            1 = 完全不適用於我
            <span style="font-weight:normal; margin: 0 10px;">|</span>
            7 = 完全適用於我
        </div>

        <form id="questionnaire-form">
            <div id="question-list"></div>
            <div id="error-message">尚有題目未作答，請檢查下方標紅的題目。</div>
            <div style="text-align: center; margin-top: 30px;">
                <button type="submit" class="btn">計算我的分數</button>
            </div>
        </form>

        <div id="results">
            <h2>你的結果</h2>
            <div class="result-style">
                <h3>適應型風格 (Adaptive Style)</h3>
                <p>此風格反映出健康、成熟及具建設性的方式來應對壓力、衝突和困難情緒。高分者傾向能靈活處理挑戰，例如尋求支援、制定計劃、運用幽默感，並將精力轉化為有建設性的活動。</p>
                <p id="adaptive-style-score" class="style-score"></p>
                <div class="chart-container">
                    <canvas id="adaptive-chart"></canvas>
                </div>
            </div>

            <div class="result-style">
                <h3>情感調節型風格 (Affect-Regulating Style)</h3>
                <p>此風格透過將困擾的情緒排除在意識之外來進行管理。相關的防衛機制可能包括將感受理智化、與情境保持情感距離，或為衝突作出合理解釋。雖然此風格有時有用，但過度依賴可能會抑制情感表達和自我覺察。</p>
                <p id="affect-regulating-style-score" class="style-score"></p>
                <div class="chart-container">
                    <canvas id="affect-regulating-chart"></canvas>
                </div>
            </div>

            <div class="result-style">
                <h3>影像扭曲型風格 (Image-Distorting Style)</h3>
                <p>此風格透過扭曲對自己或他人的看法來處理內心困擾。這可能包括以黑白分明的角度看待人或事（非好即壞）、指責他人或衝動行事。高分者通常與人際關係困難和較無效的應對策略有關。</p>
                <p id="image-distorting-style-score" class="style-score"></p>
                <div class="chart-container">
                    <canvas id="image-distorting-chart"></canvas>
                </div>
            </div>
            
            <div class="export-buttons">
                <button id="export-html-btn" class="btn btn-success">匯出HTML報告 (推薦，最高品質)</button>
                <button id="export-pdf-btn" class="btn btn-secondary">匯出多頁PDF報告</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for PDF generation progress -->
    <div id="pdf-progress-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>正在產生PDF報告...</h3>
            <p>這可能需要幾秒鐘的時間，請稍候。</p>
            <p id="pdf-progress-text">準備中...</p>
        </div>
    </div>
    
    <!-- Hidden container for PDF cover page rendering -->
    <div id="pdf-cover-page">
        <h1>DSQ-60 結果報告</h1>
        <p id="pdf-cover-name"></p>
        <p id="pdf-cover-date"></p>
    </div>

    <script>
        // --- MODIFICATION START: Updated Question 1 Text ---
        const questions = [
            { qNum: 1, text: "我從幫助他人中獲得滿足感，如果無法這樣做，我會感到沮喪。" }, // This line has been updated
            { qNum: 2, text: "人們常說我會鬧彆扭／生悶氣。" },
            { qNum: 3, text: "我能夠暫時將問題拋諸腦後，直到我有時間處理它為止。" },
            { qNum: 4, text: "我透過做一些有建設性和創造性的事（如繪畫或木工）來排解我的焦慮。" },
            { qNum: 5, text: "我對人的看法經常改變；一時之間我會高度評價他們，另一時間我又覺得他們一文不值。" },
            { qNum: 6, text: "我總能為自己做的每件事找到合理的理由。" },
            { qNum: 7, text: "我能夠輕易地自嘲。" },
            { qNum: 8, text: "我覺得人們傾向於虧待我。" },
            { qNum: 9, text: "如果有人搶劫並偷了我的錢，我寧願他得到幫助而不是懲罰。" },
            { qNum: 10, text: "當我與人發生衝突時，我會嘗試思考自己在哪方面有責任。" },
            { qNum: 11, text: "人們說我傾向於忽略不愉快的事實，彷彿它們不存在一樣。" },
            { qNum: 12, text: "我時常覺得自己比身邊的人優越。" },
            { qNum: 13, text: "有人正在情感上榨乾我的一切。" },
            { qNum: 14, text: "當遇到真正的危險時，我彷彿置身事外，感覺不到恐懼。" },
            { qNum: 15, text: "如果我受到不公平對待，我會挺身而出捍衛自己的權利。" },
            { qNum: 16, text: "我應對危險時，就像自己是超人一樣。" },
            { qNum: 17, text: "我為自己能夠挫他人的銳氣而感到自豪。" },
            { qNum: 18, text: "當有事情困擾我時，我常常會衝動行事。" },
            { qNum: 19, text: "事實上，我頗沒有價值。" },
            { qNum: 20, text: "與人相處時，他們最終往往會感受到我的感受。" },
            { qNum: 21, text: "我從幻想中得到的滿足感比從現實生活中得到的更多。" },
            { qNum: 22, text: "當我生氣時，我會選擇退縮。" },
            { qNum: 23, text: "當我身處困境時，我時常感到不真實。" },
            { qNum: 24, text: "我擁有特殊才能，讓我可以毫無問題地度過一生。" },
            { qNum: 25, text: "我寧願談論抽象的事情，也不願談論我的感受。" },
            { qNum: 26, text: "當事情不順利時，總是有很好的理由可以解釋。" },
            { qNum: 27, text: "我在白日夢中解決的事情比在現實生活中更多。" },
            { qNum: 28, text: "當別人生我的氣時，我傾向於認為他們小題大作。" },
            { qNum: 29, text: "有時我覺得自己是天使，有時又覺得自己是魔鬼。" },
            { qNum: 30, text: "如果有人對我生氣，我會因為一些平常不在意的事情而感到煩惱。" },
            { qNum: 31, text: "當我感到受傷時，我會變得公然地具攻擊性。" },
            { qNum: 32, text: "我幾乎不記得任何關於我早年上學的事情。" },
            { qNum: 33, text: "當我悲傷時，我會選擇退縮。" },
            { qNum: 34, text: "我總覺得我認識的某個人就像一位守護天使。" },
            { qNum: 35, text: "事實上，我比人們想像的還要差。" },
            { qNum: 36, text: "對我來說，人要麼是好人，要麼是壞人。" },
            { qNum: 37, text: "如果我的上司惹惱我，我可能會在工作中犯錯或故意放慢工作速度來報復他。" },
            { qNum: 38, text: "我認識一個人，他無所不能，而且絕對公平公正。" },
            { qNum: 39, text: "如果我經歷了不愉快的事情，第二天有時我會忘記那是什麼事。" },
            { qNum: 40, text: "幫助他人讓我感覺良好。" },
            { qNum: 41, text: "如果表達感受會干擾我正在做的事，我能夠抑制自己的情緒。" },
            { qNum: 42, text: "在痛苦的困境中，我通常能看到其中有趣的一面。" },
            { qNum: 43, text: "我常常發現自己對那些理應讓我生氣的人非常友善。" },
            { qNum: 44, text: "沒有「在每個人身上找到一點好處」這回事，如果你是壞人，你就是徹頭徹尾的壞人。" },
            { qNum: 45, text: "當我做的事情結果不佳時，我會試圖找出我可能忽略了什麼。" },
            { qNum: 46, text: "我覺得人們傾向於對我不誠實。" },
            { qNum: 47, text: "當我必須面對困難情況時，我會嘗試想像那會是怎樣的，並計劃應對方法。" },
            { qNum: 48, text: "醫生從來沒有真正了解我的問題出在哪裡。" },
            { qNum: 49, text: "在我為自己的權利抗爭後，我傾向於為自己的堅定立場道歉。" },
            { qNum: 50, text: "如果有人惹惱我，我會告訴他們，但不會傷害他們的感情。" },
            { qNum: 51, text: "我經常被告知我不表露自己的感受。" },
            { qNum: 52, text: "當我心情不好時，我會想和別人在一起。" },
            { qNum: 53, text: "如果我能預先知道自己將會難過，我就能更好地應對。" },
            { qNum: 54, text: "無論我怎樣投訴，都從未得到滿意的回應。" },
            { qNum: 55, text: "我不會直接說出我的感受，而是會詳細地解釋我的想法。" },
            { qNum: 56, text: "在理應有強烈情緒反應的情況下，我常常發現自己沒有任何感覺。" },
            { qNum: 57, text: "當我感到沮喪或焦慮時，我喜歡從事一些創造性或體能活動。" },
            { qNum: 58, text: "如果我陷入危機，我會找人傾訴我的憂慮。" },
            { qNum: 59, text: "當我有一個具攻擊性的想法時，我覺得有必要做些事情來彌補它。" },
            { qNum: 60, text: "當有令人興奮的事情發生時，我卻傾向於為一些不重要的細節而煩惱。" }
        ];
        // --- MODIFICATION END ---

        const questionMapping = {
            '昇華': { items: [4, 57], style: 'adaptive' },
            '壓抑': { items: [3, 41], style: 'adaptive' },
            '幽默': { items: [7, 42], style: 'adaptive' },
            '預期': { items: [47, 53], style: 'adaptive' },
            '利他主義': { items: [1, 40], style: 'adaptive' },
            '自我肯定': { items: [15, 50], style: 'adaptive' },
            '自我觀察': { items: [10, 45], style: 'adaptive' },
            '求助': { items: [52, 58], style: 'adaptive' },
            '潛抑': { items: [32, 39], style: 'affectRegulating' },
            '解離': { items: [14, 23], style: 'affectRegulating' },
            '孤立': { items: [51, 56], style: 'affectRegulating' },
            '理智化': { items: [25, 55], style: 'affectRegulating' },
            '合理化': { items: [6, 26], style: 'affectRegulating' },
            '反應形成': { items: [9, 43], style: 'affectRegulating' },
            '抵消': { items: [49, 59], style: 'affectRegulating' },
            '否認': { items: [11, 28], style: 'imageDistorting' },
            '投射': { items: [8, 46], style: 'imageDistorting' },
            '分裂/他人': { items: [5, 36], style: 'imageDistorting' },
            '分裂/自我': { items: [29, 44], style: 'imageDistorting' },
            '貶低/他人': { items: [12, 17], style: 'imageDistorting' },
            '貶低/自我': { items: [19, 35], style: 'imageDistorting' },
            '理想化': { items: [34, 38], style: 'imageDistorting' },
            '全能': { items: [16, 24], style: 'imageDistorting' },
            '幻想': { items: [21, 27], style: 'imageDistorting' },
            '行動化': { items: [18, 31], style: 'imageDistorting' },
            '被動攻擊': { items: [2, 37], style: 'imageDistorting' },
            '退縮': { items: [22, 33], style: 'imageDistorting' },
            '置換': { items: [30, 60], style: 'imageDistorting' },
            '投射性認同': { items: [13, 20], style: 'imageDistorting' },
            '拒絕幫助的抱怨': { items: [48, 54], style: 'imageDistorting' },
        };

        const questionList = document.getElementById('question-list');
        questions.forEach(q => {
            const item = document.createElement('div');
            item.className = 'question-item';
            item.id = `q-item-${q.qNum}`;
            
            let optionsHtml = '';
            for (let i = 1; i <= 7; i++) {
                optionsHtml += `
                    <label for="q${q.qNum}-${i}">
                        <input type="radio" id="q${q.qNum}-${i}" name="q${q.qNum}" value="${i}" required>
                        <span>${i}</span>
                    </label>
                `;
            }

            item.innerHTML = `
                <div class="question-text">${q.qNum}. ${q.text}</div>
                <div class="options-container">
                    ${optionsHtml}
                </div>
            `;
            questionList.appendChild(item);
        });
        
        questionList.addEventListener('change', (e) => {
            if (e.target.type === 'radio') {
                const container = e.target.closest('.options-container');
                container.querySelectorAll('label').forEach(label => {
                    label.classList.remove('selected');
                });
                e.target.parentElement.classList.add('selected');
                
                const questionItem = e.target.closest('.question-item');
                if (questionItem.classList.contains('unanswered')) {
                    questionItem.classList.remove('unanswered');
                }
            }
        });


        const charts = {};

        function createChart(canvasId, label, data, backgroundColor, borderColor) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        label: label,
                        data: data.map(d => d.score),
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // 保持為水平長條圖
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 7
                        },
                        // --- MODIFICATION START: 新增 Y 軸標籤設定 ---
                        y: {
                            ticks: {
                                // autoSkip: false, // 確保所有標籤都顯示
                                // callback 用於自訂標籤的顯示方式
                                callback: function(value, index, ticks) {
                                    // this.getLabelForValue(value) 取得原始標籤文字
                                    const label = this.getLabelForValue(value);
                                    const maxLength = 5; // 設定每行最大字數

                                    // 如果標籤長度超過最大長度，就進行換行處理
                                    if (label.length > maxLength) {
                                        const wrappedLabel = [];
                                        for (let i = 0; i < label.length; i += maxLength) {
                                            wrappedLabel.push(label.substring(i, i + maxLength));
                                        }
                                        // Chart.js 支援用陣列來顯示多行標籤
                                        return wrappedLabel;
                                    }
                                    // 如果標籤不長，直接返回
                                    return label;
                                }
                            }
                        }
                        // --- MODIFICATION END ---
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    responsive: true,
                    // 調整長寬比，給標籤留出更多空間
                    maintainAspectRatio: false 
                }
            });
            return charts[canvasId];
        }

        document.getElementById('questionnaire-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const answers = {};
            let allAnswered = true;
            
            document.querySelectorAll('.question-item').forEach(item => item.classList.remove('unanswered'));

            for (let i = 1; i <= questions.length; i++) {
                const answer = formData.get(`q${i}`);
                if (answer) {
                    answers[i] = parseInt(answer, 10);
                } else {
                    allAnswered = false;
                    document.getElementById(`q-item-${i}`).classList.add('unanswered');
                }
            }

            const errorMessage = document.getElementById('error-message');
            if (!allAnswered) {
                errorMessage.style.display = 'block';
                const firstUnanswered = document.querySelector('.unanswered');
                if (firstUnanswered) {
                    firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            errorMessage.style.display = 'none';

            const scores = {};
            for (const defense in questionMapping) {
                const { items } = questionMapping[defense];
                const total = items.reduce((sum, qNum) => sum + answers[qNum], 0);
                scores[defense] = total / items.length;
            }

            const styleScores = {
                adaptive: { total: 0, count: 0, defenses: [] },
                affectRegulating: { total: 0, count: 0, defenses: [] },
                imageDistorting: { total: 0, count: 0, defenses: [] }
            };

            for (const defense in scores) {
                const { style } = questionMapping[defense];
                styleScores[style].total += scores[defense];
                styleScores[style].count++;
                styleScores[style].defenses.push({ label: defense, score: scores[defense] });
            }

            const adaptiveScore = styleScores.adaptive.total / styleScores.adaptive.count;
            const affectRegulatingScore = styleScores.affectRegulating.total / styleScores.affectRegulating.count;
            const imageDistortingScore = styleScores.imageDistorting.total / styleScores.imageDistorting.count;

            document.getElementById('adaptive-style-score').textContent = `總體風格分數: ${adaptiveScore.toFixed(2)}`;
            document.getElementById('affect-regulating-style-score').textContent = `總體風格分數: ${affectRegulatingScore.toFixed(2)}`;
            document.getElementById('image-distorting-style-score').textContent = `總體風格分數: ${imageDistortingScore.toFixed(2)}`;

            styleScores.adaptive.defenses.sort((a, b) => b.score - a.score);
            styleScores.affectRegulating.defenses.sort((a, b) => b.score - a.score);
            styleScores.imageDistorting.defenses.sort((a, b) => b.score - a.score);

            charts.adaptive = createChart('adaptive-chart', '適應型防衛', styleScores.adaptive.defenses, 'rgba(46, 204, 113, 0.6)', 'rgba(46, 204, 113, 1)');
            charts.affectRegulating = createChart('affect-regulating-chart', '情感調節型防衛', styleScores.affectRegulating.defenses, 'rgba(52, 152, 219, 0.6)', 'rgba(52, 152, 219, 1)');
            charts.imageDistorting = createChart('image-distorting-chart', '影像扭曲型防衛', styleScores.imageDistorting.defenses, 'rgba(231, 76, 60, 0.6)', 'rgba(231, 76, 60, 1)');

            document.getElementById('results').style.display = 'block';
            window.scrollTo({ top: document.getElementById('results').offsetTop, behavior: 'smooth' });
        });
        
        document.getElementById('export-html-btn').addEventListener('click', () => {
            const name = document.getElementById('name').value || '未提供';
            const date = new Date().toLocaleString('zh-TW', { hour12: false });

            const adaptiveChartImg = charts.adaptive ? charts.adaptive.toBase64Image() : '';
            const affectChartImg = charts.affectRegulating ? charts.affectRegulating.toBase64Image() : '';
            const imageChartImg = charts.imageDistorting ? charts.imageDistorting.toBase64Image() : '';

            const adaptiveScore = document.getElementById('adaptive-style-score').textContent;
            const affectScore = document.getElementById('affect-regulating-style-score').textContent;
            const imageScore = document.getElementById('image-distorting-style-score').textContent;
            
            const qNumToDefenseMap = {};
            for (const defenseName in questionMapping) {
                questionMapping[defenseName].items.forEach(qNum => {
                    qNumToDefenseMap[qNum] = defenseName;
                });
            }

            const styleToRowColorMap = {
                adaptive: 'rgba(46, 204, 113, 0.15)',
                affectRegulating: 'rgba(52, 152, 219, 0.15)',
                imageDistorting: 'rgba(231, 76, 60, 0.15)'
            };

            let answerRowsHtml = '';
            for (let i = 1; i <= questions.length; i++) {
                const question = questions.find(q => q.qNum === i);
                const answer = document.querySelector(`input[name="q${i}"]:checked`).value;
                
                const defense = qNumToDefenseMap[i];
                const style = questionMapping[defense].style;
                const rowColor = styleToRowColorMap[style];

                answerRowsHtml += `
                    <tr style="background-color: ${rowColor};">
                        <td>${question.qNum}</td>
                        <td>${question.text}</td>
                        <td>${defense}</td>
                        <td>${answer}</td>
                    </tr>
                `;
            }

            let cssText = '';
            for (let sheet of document.styleSheets) {
                try {
                    for (let rule of sheet.cssRules) { cssText += rule.cssText; }
                } catch (e) { console.warn("Could not read CSS rule due to security policy.", e); }
            }

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="zh-Hant">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>DSQ-60 結果報告 - ${name}</title>
                    <style>${cssText}</style>
                    <style> 
                        body { padding: 20px; background-color: #fff; } 
                        .export-buttons, #questionnaire-form, .modal, #pdf-cover-page { display: none !important; }
                        #results { display: block !important; border-top: none; margin-top: 0; padding-top: 0; }
                        .answers-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
                        .answers-table th, .answers-table td { border: 1px solid #dee2e6; padding: 8px 12px; text-align: left; }
                        .answers-table th { background-color: #f8f9fa; font-weight: bold; }
                        .answers-table td:nth-child(1), .answers-table td:nth-child(4) { text-align: center; }
                        .color-legend { border: 1px solid #e0e0e0; padding: 10px; border-radius: 5px; background-color: #f8f9fa;}
                        .color-legend span { padding: 2px 8px; border-radius: 4px; font-weight: 500; margin: 0 4px; display: inline-block;}
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>DSQ-60 結果報告</h1>
                        <p><strong>姓名:</strong> ${name}</p>
                        <p><strong>完成日期:</strong> ${date}</p>
                        <hr>

                        <div id="detailed-answers">
                            <h2>問卷作答詳情</h2>
                            <p class="color-legend">
                                每一行都根據其所屬的防衛風格進行了顏色標記：
                                <span style="background-color: ${styleToRowColorMap.adaptive};">適應型</span>
                                <span style="background-color: ${styleToRowColorMap.affectRegulating};">情感調節型</span>
                                <span style="background-color: ${styleToRowColorMap.imageDistorting};">影像扭曲型</span>
                            </p>
                            <table class="answers-table">
                                <thead>
                                    <tr>
                                        <th style="width: 5%;">題號</th>
                                        <th style="width: 55%;">題目內容</th>
                                        <th style="width: 25%;">對應防衛機制</th>
                                        <th style="width: 15%;">你的回答 (1-7)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${answerRowsHtml}
                                </tbody>
                            </table>
                        </div>
                        <hr style="margin: 30px 0;">

                        <div id="results">
                            <h2>結果總覽</h2>
                            <div class="result-style">
                                <h3>適應型風格 (Adaptive Style)</h3>
                                <p>此風格反映出健康、成熟及具建設性的方式來應對壓力、衝突和困難情緒。高分者傾向能靈活處理挑戰，例如尋求支援、制定計劃、運用幽默感，並將精力轉化為有建設性的活動。</p>
                                <p class="style-score">${adaptiveScore}</p>
                                <div class="chart-container"><img src="${adaptiveChartImg}" style="width:100%; height:auto;"></div>
                            </div>
                            <div class="result-style">
                                <h3>情感調節型風格 (Affect-Regulating Style)</h3>
                                <p>此風格透過將困擾的情緒排除在意識之外來進行管理。相關的防衛機制可能包括將感受理智化、與情境保持情感距離，或為衝突作出合理解釋。雖然此風格有時有用，但過度依賴可能會抑制情感表達和自我覺察。</p>
                                <p class="style-score">${affectScore}</p>
                                <div class="chart-container"><img src="${affectChartImg}" style="width:100%; height:auto;"></div>
                            </div>
                            <div class="result-style">
                                <h3>影像扭曲型風格 (Image-Distorting Style)</h3>
                                <p>此風格透過扭曲對自己或他人的看法來處理內心困擾。這可能包括以黑白分明的角度看待人或事（非好即壞）、指責他人或衝動行事。高分者通常與人際關係困難和較無效的應對策略有關。</p>
                                <p class="style-score">${imageScore}</p>
                                <div class="chart-container"><img src="${imageChartImg}" style="width:100%; height:auto;"></div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `DSQ-60_完整報告_${name.replace(/\s+/g, '_')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        });
        
        const { jsPDF } = window.jspdf;

        document.getElementById('export-pdf-btn').addEventListener('click', async () => {
            const modal = document.getElementById('pdf-progress-modal');
            const progressText = document.getElementById('pdf-progress-text');
            modal.style.display = 'block';

            try {
                const doc = new jsPDF({
                    orientation: 'p',
                    unit: 'px',
                    format: 'a4'
                });
                
                const name = document.getElementById('name').value || '未提供';
                const date = new Date().toLocaleString('zh-TW', { hour12: false });
                
                progressText.textContent = '正在產生封面... (1/3)';
                document.getElementById('pdf-cover-name').textContent = `姓名: ${name}`;
                document.getElementById('pdf-cover-date').textContent = `完成日期: ${date}`;
                const coverPage = document.getElementById('pdf-cover-page');
                coverPage.style.display = 'block';
                
                const coverCanvas = await html2canvas(coverPage, { scale: 2, useCORS: true });
                const coverImgData = coverCanvas.toDataURL('image/png');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                doc.addImage(coverImgData, 'PNG', 0, 0, pageWidth, pageHeight);
                coverPage.style.display = 'none';

                progressText.textContent = '正在產生作答詳情... (2/3)';
                doc.addPage();
                
                const tempTableContainer = document.createElement('div');
                tempTableContainer.style.position = 'absolute';
                tempTableContainer.style.left = '-9999px';
                tempTableContainer.style.width = '800px';
                
                const htmlContent = (await (async () => {
                    const qNumToDefenseMap = {};
                    for (const defenseName in questionMapping) {
                        questionMapping[defenseName].items.forEach(qNum => {
                            qNumToDefenseMap[qNum] = defenseName;
                        });
                    }
                    const styleToRowColorMap = {
                        adaptive: 'rgba(46, 204, 113, 0.15)',
                        affectRegulating: 'rgba(52, 152, 219, 0.15)',
                        imageDistorting: 'rgba(231, 76, 60, 0.15)'
                    };
                    let answerRowsHtml = '';
                    for (let i = 1; i <= questions.length; i++) {
                        const question = questions.find(q => q.qNum === i);
                        const answer = document.querySelector(`input[name="q${i}"]:checked`).value;
                        const defense = qNumToDefenseMap[i];
                        const style = questionMapping[defense].style;
                        const rowColor = styleToRowColorMap[style];
                        answerRowsHtml += `<tr style="background-color: ${rowColor};"><td>${question.qNum}</td><td>${question.text}</td><td>${defense}</td><td>${answer}</td></tr>`;
                    }
                    return `<h2>問卷作答詳情</h2><table class="answers-table" style="width: 100%; border-collapse: collapse; font-size: 12px;"><thead><tr><th style="width: 5%;">題號</th><th style="width: 55%;">題目內容</th><th style="width: 25%;">對應防衛機制</th><th style="width: 15%;">你的回答</th></tr></thead><tbody>${answerRowsHtml}</tbody></table>`;
                })());
                
                tempTableContainer.innerHTML = `<div style="padding: 20px;">${htmlContent}</div>`;
                document.body.appendChild(tempTableContainer);

                await doc.html(tempTableContainer, {
                    callback: function (doc) {
                        document.body.removeChild(tempTableContainer);
                    },
                    x: 10,
                    y: 10,
                    width: pageWidth - 20,
                    windowWidth: 800
                });

                progressText.textContent = '正在產生結果圖表... (3/3)';
                doc.addPage();
                const resultsElement = document.getElementById('results');
                const originalDisplay = resultsElement.style.display;
                resultsElement.style.display = 'block';
                
                await doc.html(resultsElement, {
                    callback: function (doc) {
                        resultsElement.style.display = originalDisplay;
                        progressText.textContent = '完成！';
                        setTimeout(() => { modal.style.display = 'none'; }, 1000);
                        doc.save(`DSQ-60_報告_${name.replace(/\s+/g, '_')}.pdf`);
                    },
                    x: 10,
                    y: 10,
                    width: pageWidth - 20,
                    windowWidth: resultsElement.scrollWidth
                });

            } catch (error) {
                console.error("PDF generation failed:", error);
                progressText.textContent = '產生失敗，請檢查控制台錯誤。';
                setTimeout(() => { modal.style.display = 'none'; }, 3000);
            }
        });
        
        document.querySelector('.close-btn').onclick = function() {
            document.getElementById('pdf-progress-modal').style.display = "none";
        }
        window.onclick = function(event) {
            const modal = document.getElementById('pdf-progress-modal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

    </script>
</body>
</html>
