<!DOCTYPE html><html lang="zh-Hant"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSQ-60 互動問卷 (七點量表版)</title>
    <!-- 引入 Chart.js 用於繪製圖表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入 jsPDF 和 html2canvas 用於匯出 PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 25px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .question-item {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fdfdfd;
            transition: all 0.3s ease;
        }
        .question-item.unanswered {
            border: 2px solid #e74c3c;
            background-color: #fbeae5;
        }
        .scale {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        .scale label {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            min-width: 45px;
            border-radius: 4px;
            transition: background-color 0.2s;
            font-size: 0.9em;
        }
        .scale input[type="radio"] {
            margin-bottom: 5px;
        }
        .scale label:hover {
            background-color: #ecf0f1;
        }
        .main-button, .secondary-button {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            text-align: center;
            transition: background-color 0.3s, transform 0.1s;
        }
        .main-button:hover {
            background-color: #2980b9;
        }
        .main-button {
            background-color: #3498db;
        }
        .secondary-button {
            background-color: #27ae60;
            font-size: 1.1em;
            margin-top: 10px;
        }
        .secondary-button:hover {
            background-color: #229954;
        }
        #results {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
            display: none;
        }
        .result-style {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .result-style h3 {
            margin-top: 0;
            color: #2980b9;
        }
        .style-score {
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
        }
        .chart-container {
            margin-top: 20px;
        }
        .error-message {
            color: #c0392b;
            font-weight: bold;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #c0392b;
            background-color: #f9e5e3;
            border-radius: 5px;
            display: none;
        }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-close {
            color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        /* Hidden element for PDF cover page rendering */
        #pdf-cover-page {
            position: absolute;
            left: -9999px; /* Move off-screen */
            top: -9999px;
            width: 595px; /* A4 width in points */
            height: 842px; /* A4 height in points */
            background: white;
            padding: 40px;
            box-sizing: border-box;
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script></head>
<body>

    <div class="container">
        <h1>DSQ-60 互動問卷 (七點量表版)</h1>

        <div id="questionnaire-form">
            <div class="personal-info">
                <h2>個人資料</h2>
                <div class="form-group">
                    <label for="name">姓名</label>
                    <input type="text" id="name" name="name" placeholder="請輸入你的姓名（可選）">
                </div>
            </div>
            <div class="instructions">
                <h2>問卷說明</h2>
                <p>本問卷旨在了解個人對自己的看法。請根據以下七點量表，指出每個項目在多大程度上適用於你。</p>
                <p><b>1 = 完全不適用於我</b> | <b>7 = 完全適用於我</b></p>
            </div>
            <form id="dsq-form"></form>
            <div id="error-message" class="error-message">尚有題目未作答，請檢查下方標紅的題目。</div>
            <button type="button" id="calculate-btn" class="main-button">計算我的分數</button>
        </div>

        <div id="results">
            <h2>你的結果</h2>
            <div id="adaptive-result" class="result-style">
                <h3>適應型風格 (Adaptive Style)</h3>
                <p>此風格反映出健康、成熟及具建設性的方式來應對壓力、衝突和困難情緒。高分者傾向能靈活處理挑戰，例如尋求支援、制定計劃、運用幽默感，並將精力轉化為有建設性的活動。</p>
                <p class="style-score" id="adaptive-style-score"></p>
                <div class="chart-container">
                    <canvas id="adaptive-chart"></canvas>
                </div>
            </div>
            <div id="affect-regulating-result" class="result-style">
                <h3>情感調節型風格 (Affect-Regulating Style)</h3>
                <p>此風格透過將困擾的情緒排除在意識之外來進行管理。相關的防衛機制可能包括將感受理智化、與情境保持情感距離，或為衝突作出合理解釋。雖然此風格有時有用，但過度依賴可能會抑制情感表達和自我覺察。</p>
                <p class="style-score" id="affect-regulating-style-score"></p>
                 <div class="chart-container">
                    <canvas id="affect-regulating-chart"></canvas>
                </div>
            </div>
            <div id="image-distorting-result" class="result-style">
                <h3>影像扭曲型風格 (Image-Distorting Style)</h3>
                <p>此風格透過扭曲對自己或他人的看法來處理內心困擾。這可能包括以黑白分明的角度看待人或事（非好即壞）、指責他人或衝動行事。高分者通常與人際關係困難和較無效的應對策略有關。</p>
                <p class="style-score" id="image-distorting-style-score"></p>
                 <div class="chart-container">
                    <canvas id="image-distorting-chart"></canvas>
                </div>
            </div>
            <div class="export-buttons">
                 <button type="button" id="export-html-btn" class="secondary-button">匯出HTML報告 (推薦，最高品質)</button>
                 <button type="button" id="export-pdf-btn" class="main-button">匯出多頁PDF報告</button>
            </div>
        </div>
    </div>

    <!-- Modal for Explanations -->
    <div id="explanation-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">×</span>
            <h3 id="modal-title"></h3>
            <p id="modal-text"></p>
        </div>
    </div>
    
    <!-- Hidden container for rendering the PDF cover page -->
    <div id="pdf-cover-page"></div>

    <script>
        // --- JAVASCRIPT LOGIC ---
        const questions = [ { "qNum": 1, "text": "當我幫助別人時，我感到滿足；如果不能這樣做，我會感到沮喪。" }, { "qNum": 2, "text": "人們常說我悶悶不樂、沉默寡言。" }, { "qNum": 3, "text": "我可以暫時不去想某個問題，直到我有時間去處理它。" }, { "qNum": 4, "text": "我透過從事繪畫或木工等有建設性和創造性的活動來控制我的焦慮。" }, { "qNum": 5, "text": "我對人的看法經常改變；有時我對他們評價很高，有時又覺得他們一文不值。" }, { "qNum": 6, "text": "我能為我做的任何事找到充分的理由。" }, { "qNum": 7, "text": "我可以很輕易地嘲笑自己。" }, { "qNum": 8, "text": "人們似乎傾向於不公平地對待我。" }, { "qNum": 9, "text": "如果有人攻擊我並搶走我的錢，我寧願他得到幫助而不是懲罰。" }, { "qNum": 10, "text": "如果我與某人發生衝突，我會試著去思考我在這場衝突中可能有什麼責任。" }, { "qNum": 11, "text": "人們說我傾向於忽略不愉快的事實，彷彿它們不存在一樣。" }, { "qNum": 12, "text": "我常常感到自己比周遭的人優越。" }, { "qNum": 13, "text": "有人正在情感上榨乾我的一切。" }, { "qNum": 14, "text": "當有真正的危險時，我感覺好像自己不在那裡，而且我不害怕。" }, { "qNum": 15, "text": "如果我受到不公平的對待，我會為自己的權利挺身而出。" }, { "qNum": 16, "text": "我處理危險時，就像我是超人/擁有超能力一樣。" }, { "qNum": 17, "text": "我為自己能把人打回原形的能力感到自豪。" }, { "qNum": 18, "text": "當有事情困擾我時，我經常會衝動行事。" }, { "qNum": 19, "text": "事實上，我相當沒有價值。" }, { "qNum": 20, "text": "當我與人打交道時，他們常常最終感受到我的感受。" }, { "qNum": 21, "text": "我從我的幻想中得到的滿足感比從我的現實生活中得到的更多。" }, { "qNum": 22, "text": "當我難過時，我會退縮。" }, { "qNum": 23, "text": "當我遇到困難時，我常常感到不真實。" }, { "qNum": 24, "text": "我有特殊才能，讓我可以毫無問題地度過一生。" }, { "qNum": 25, "text": "我寧願談論抽象的事情，也不願談論我的感受。" }, { "qNum": 26, "text": "當事情不順利時，總是有充分的理由。" }, { "qNum": 27, "text": "我透過白日夢完成的事情比在現實生活中更多。" }, { "qNum": 28, "text": "當人們對我生氣時，我傾向於認為他們反應過度了。" }, { "qNum": 29, "text": "有時我認為自己是個天使，有時我認為自己非常壞。" }, { "qNum": 30, "text": "如果有人讓我生氣，我傾向於對一些我通常會忽略的事情感到煩惱。" }, { "qNum": 31, "text": "當我感到受傷時，我會變得公然具有攻擊性。" }, { "qNum": 32, "text": "我不太記得我的小學時光。" }, { "qNum": 33, "text": "當我悲傷時，我會退縮。" }, { "qNum": 34, "text": "我總覺得我認識的某個人是我的守護天使。" }, { "qNum": 35, "text": "我通常比人們想像的要糟糕。" }, { "qNum": 36, "text": "對我來說，人要麼是好人，要麼是壞人。" }, { "qNum": 37, "text": "如果我的老闆讓我生氣，我可能會在工作上犯錯或故意放慢速度來報復。" }, { "qNum": 38, "text": "我認識的某個人可以做任何事，並且絕對公平正直。" }, { "qNum": 39, "text": "如果我經歷了不愉快的事情，第二天有時會忘記那是什麼事。" }, { "qNum": 40, "text": "幫助別人讓我感覺很好。" }, { "qNum": 41, "text": "如果表露情緒會干擾我正在做的事，我可以控制住我的情緒。" }, { "qNum": 42, "text": "我通常能看到一個原本嚴肅情況下的幽默面。" }, { "qNum": 43, "text": "我常常發現自己對那些我理應生氣的人非常友善。" }, { "qNum": 44, "text": "沒有所謂「在每個人身上找到優點」這回事；如果你壞，你就是徹頭徹尾的壞。" }, { "qNum": 45, "text": "當我做的事情不順利時，我會試著找出我忽略了什麼。" }, { "qNum": 46, "text": "人們傾向於對我不誠實或不公平。" }, { "qNum": 47, "text": "如果我必須面對一個困難情況時，我會試著想像它會是什麼樣子，並計畫應對的方法。" }, { "qNum": 48, "text": "醫生似乎從來都無法完全理解我的問題。" }, { "qNum": 49, "text": "在為自己的權利奮鬥後，我傾向於為自己的強勢道歉。" }, { "qNum": 50, "text": "如果有人惹惱我，我會告訴他們，而不會傷害他們。" }, { "qNum": 51, "text": "人們常告訴我，我不表露我的感受。" }, { "qNum": 52, "text": "當我感覺不好時，我喜歡和某人在一起。" }, { "qNum": 53, "text": "如果我能預見到我將會感到難過，我就能更好地應對這種情況。" }, { "qNum": 54, "text": "無論我怎麼抱怨，我都得不到別人滿意的回應。" }, { "qNum": 55, "text": "我不直接說出我的感受，而是詳細地解釋我的想法。" }, { "qNum": 56, "text": "當我感到情緒激動的事情時，我卻沒有任何感覺。" }, { "qNum": 57, "text": "當我感到沮喪或焦慮時，我喜歡投入一項創造性或體能活動。" }, { "qNum": 58, "text": "如果我陷入危機，我會找人傾訴我的煩惱。" }, { "qNum": 59, "text": "如果我有一個攻擊性的想法，我會感到需要做些什麼來彌補它。" }, { "qNum": 60, "text": "當發生情緒激動的事情時，我傾向於關注不重要的細節。" } ];
        const questionMapping = { '利他主義': { items: [1, 40], style: 'adaptive' }, '被動攻擊': { items: [2, 37], style: 'imageDistorting' }, '壓抑': { items: [3, 41], style: 'adaptive' }, '昇華': { items: [4, 57], style: 'adaptive' }, '分裂/他人': { items: [5, 36], style: 'imageDistorting' }, '合理化': { items: [6, 26], style: 'affectRegulating' }, '幽默': { items: [7, 42], style: 'adaptive' }, '投射': { items: [8, 46], style: 'imageDistorting' }, '反應形成': { items: [9, 43], style: 'affectRegulating' }, '自我觀察': { items: [10, 45], style: 'adaptive' }, '否認': { items: [11, 28], style: 'imageDistorting' }, '貶低/他人': { items: [12, 17], style: 'imageDistorting' }, '投射性認同': { items: [13, 20], style: 'imageDistorting' }, '解離': { items: [14, 23], style: 'affectRegulating' }, '自我肯定': { items: [15, 50], style: 'adaptive' }, '全能': { items: [16, 24], style: 'imageDistorting' }, '行動化': { items: [18, 31], style: 'imageDistorting' }, '貶低/自我': { items: [19, 35], style: 'imageDistorting' }, '幻想': { items: [21, 27], style: 'affectRegulating' }, '退縮': { items: [22, 33], style: 'affectRegulating' }, '理智化': { items: [25, 55], style: 'affectRegulating' }, '分裂/自我': { items: [29, 44], style: 'imageDistorting' }, '置換': { items: [30, 60], style: 'affectRegulating' }, '潛抑': { items: [32, 39], style: 'affectRegulating' }, '理想化': { items: [34, 38], style: 'imageDistorting' }, '孤立': { items: [51, 56], style: 'affectRegulating' }, '拒絕幫助的抱怨': { items: [48, 54], style: 'imageDistorting' }, '抵消': { items: [49, 59], style: 'affectRegulating' }, '預期': { items: [47, 53], style: 'adaptive' }, '求助': { items: [52, 58], style: 'adaptive' } };
        const defenseExplanations = { '利他主義': '透過幫助他人來處理自己的內心衝突或壓力，從而獲得替代性的滿足感。', '被動攻擊': '以間接、隱蔽的方式表達對他人或情境的攻擊性，例如拖延、固執、故意犯錯等。', '壓抑': '有意識地將不想要的想法、感受或衝動暫時排除在意識之外，以便在更合適的時間處理。', '昇華': '將無法被社會接受的衝動或慾望，轉化為具有建設性、被社會認可的行為，如藝術創作或體育運動。', '分裂/他人': '將他人視為「全好」或「全壞」，無法整合對方優點和缺點，看法在兩個極端間擺盪。', '合理化': '為自己無法接受的行為、動機或感受，製造一個看似合理、合乎邏輯的解釋，以掩蓋真實原因。', '幽默': '以詼諧、有趣的方式看待困境或壓力事件，從而減輕其負面情緒影響。', '投射': '將自己內心無法接受的想法、感受或特質，歸因到他人身上，認為是別人擁有這些特質。', '反應形成': '表現出與內心真實慾望或衝動完全相反的行為，以掩蓋和控制這些不被接受的感受。', '自我觀察': '能夠反思自己的思想、感受、動機和行為，並從中學習和調整。', '否認': '拒絕承認或面對那些令人痛苦的現實、事件或感受，彷彿它們從未發生。', '貶低/他人': '透過誇大或強調他人的負面特質來貶低對方，以提升自尊或應對嫉妒感。', '投射性認同': '不僅將自己的感受投射給他人，還會無意識地引導對方產生相應的感受和行為，從而「證實」自己的投射。', '解離': '在面對巨大壓力或創傷時，暫時性地改變意識、記憶、身份或對環境的知覺，感覺與現實脫節。', '自我肯定': '能夠直接、坦誠地表達自己的需求、感受和權利，同時尊重他人。', '全能': '相信自己擁有超乎常人的能力、權力或重要性，以應對無助感或自卑感。', '行動化': '透過衝動的行為來表達內心的衝突或情緒，而不是用語言來表達或反思。', '貶低/自我': '過度誇大自己的缺點和不足，將自己視為沒有價值，以應對內心的衝突或失敗感。', '幻想': '沉浸在白日夢或想像的世界中，以逃避現實生活中的不滿和挫折。', '退縮': '在面對壓力或衝突時，從社交情境或人際關係中退縮，變得孤立和被動。', '理智化': '過度使用抽象、邏輯和理性的思考方式來處理充滿情感的問題，以避免感受痛苦的情緒。', '分裂/自我': '將對自己的看法分為「全好」和「全壞」兩極，無法形成一個穩定、整合的自我形象。', '置換': '將對某個對象（通常是權威或有威脅性的人物）的強烈情緒，轉移到一個較安全、較不具威脅性的對象上。', '潛抑': '無意識地將痛苦的記憶、想法或衝動排除在意識之外，使其無法被回憶起來。', '理想化': '過度高估某個對象（人或事物）的優點，賦予其完美的特質，以滿足內心的需求或應對失望。', '孤立': '將事件的想法內容與其伴隨的情感分開，能夠回憶起事件本身，但感受不到相關的情緒。', '拒絕幫助的抱怨': '反覆向他人抱怨自己的問題，但又拒絕或貶低他人提供的任何建議或幫助。', '抵消': '試圖透過某種象徵性的行為或想法，來「抵消」或彌補一個已經發生的、無法接受的念頭或行為。', '預期': '在預期到未來可能出現的壓力或不適時，提前進行心理準備和現實規劃，以減輕其衝擊。', '求助': '在面對困難或壓力時，向他人尋求支持、安慰和幫助。' };
        
        // --- Core Application Logic (Unchanged) ---
        const form = document.getElementById('dsq-form');
        questions.forEach(q => {
            const item = document.createElement('div');
            item.className = 'question-item';
            item.id = `question-item-${q.qNum}`;
            let scaleHTML = '';
            for (let i = 1; i <= 7; i++) { scaleHTML += `<label><input type="radio" name="q${q.qNum}" value="${i}" required> ${i}</label>`; }
            item.innerHTML = `<div class="question-text">${q.qNum}. ${q.text}</div><div class="scale">${scaleHTML}</div>`;
            form.appendChild(item);
        });

        let charts = {};

        document.getElementById('calculate-btn').addEventListener('click', () => {
            let allAnswered = true, firstUnanswered = null;
            document.querySelectorAll('.question-item.unanswered').forEach(el => el.classList.remove('unanswered'));
            for (let i = 1; i <= questions.length; i++) {
                if (!document.querySelector(`input[name="q${i}"]:checked`)) {
                    allAnswered = false;
                    const questionItem = document.getElementById(`question-item-${i}`);
                    questionItem.classList.add('unanswered');
                    if (!firstUnanswered) firstUnanswered = questionItem;
                }
            }
            if (!allAnswered) {
                document.getElementById('error-message').style.display = 'block';
                if (firstUnanswered) firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            document.getElementById('error-message').style.display = 'none';
            const defenseScores = {}, styleScores = { adaptive: [], affectRegulating: [], imageDistorting: [] };
            for (const key in questionMapping) {
                const { items, style } = questionMapping[key];
                const score1 = parseInt(document.querySelector(`input[name="q${items[0]}"]:checked`).value);
                const score2 = parseInt(document.querySelector(`input[name="q${items[1]}"]:checked`).value);
                const avgScore = (score1 + score2) / 2;
                defenseScores[key] = avgScore;
                styleScores[style].push(avgScore);
            }
            const calculateAverage = arr => (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(2);
            document.getElementById('adaptive-style-score').textContent = `總體風格分數: ${calculateAverage(styleScores.adaptive)}`;
            document.getElementById('affect-regulating-style-score').textContent = `總體風格分數: ${calculateAverage(styleScores.affectRegulating)}`;
            document.getElementById('image-distorting-style-score').textContent = `總體風格分數: ${calculateAverage(styleScores.imageDistorting)}`;
            renderCharts(defenseScores);
            const resultsSection = document.getElementById('results');
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        });

        function renderCharts(scores) {
            Object.values(charts).forEach(chart => chart.destroy());
            const stylesData = {
                adaptive: { labels: [], data: [], backgroundColor: 'rgba(46, 204, 113, 0.6)' },
                affectRegulating: { labels: [], data: [], backgroundColor: 'rgba(52, 152, 219, 0.6)' },
                imageDistorting: { labels: [], data: [], backgroundColor: 'rgba(231, 76, 60, 0.6)' }
            };
            for (const defense in questionMapping) {
                const { style } = questionMapping[defense];
                stylesData[style].labels.push(defense);
                stylesData[style].data.push(scores[defense]);
            }
            charts.adaptive = createChart('adaptive-chart', '適應型防衛機制', stylesData.adaptive);
            charts.affectRegulating = createChart('affect-regulating-chart', '情感調節型防衛機制', stylesData.affectRegulating);
            charts.imageDistorting = createChart('image-distorting-chart', '影像扭曲型防衛機制', stylesData.imageDistorting);
        }

        function createChart(canvasId, label, chartData) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'bar',
                data: { labels: chartData.labels, datasets: [{ label: label, data: chartData.data, backgroundColor: chartData.backgroundColor, borderColor: chartData.backgroundColor.replace('0.6', '1'), borderWidth: 1 }] },
                options: {
                    indexAxis: 'y',
                    scales: { x: { beginAtZero: true, max: 7 } },
                    plugins: { legend: { display: false } },
                    onClick: (event, elements) => { if (elements.length > 0) showExplanation(chartData.labels[elements[0].index]); },
                    onHover: (event, chartElement) => { event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default'; }
                }
            });
        }

        const modal = document.getElementById('explanation-modal');
        function showExplanation(defenseName) {
            document.getElementById('modal-title').innerText = defenseName;
            document.getElementById('modal-text').innerText = defenseExplanations[defenseName] || '暫無詳細解釋。';
            modal.style.display = 'block';
        }
        function closeModal() { modal.style.display = 'none'; }
        window.onclick = function(event) { if (event.target == modal) closeModal(); }

        // --- UPDATED: PDF Export Logic (with Cover Page fix) ---
        document.getElementById('export-pdf-btn').addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
            const name = document.getElementById('name').value || '未提供';
            const date = new Date().toLocaleString('zh-TW', { hour12: false });
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 40;

            // --- FIX: Render cover page as an image to avoid font issues ---
            const coverPageElement = document.getElementById('pdf-cover-page');
            coverPageElement.innerHTML = `
                <div style="font-family: sans-serif; font-size: 16px; color: #2c3e50;">
                    <h1 style="font-size: 32px; text-align: center; margin-top: 60px; color: #2c3e50;">DSQ-60 結果報告</h1>
                    <p style="font-size: 18px; margin-top: 80px;"><strong>姓名:</strong> ${name}</p>
                    <p style="font-size: 18px;"><strong>完成日期:</strong> ${date}</p>
                    <hr style="margin-top: 20px;">
                </div>
            `;
            const coverCanvas = await html2canvas(coverPageElement, { scale: 2 });
            const coverImgData = coverCanvas.toDataURL('image/png');
            pdf.addImage(coverImgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

            const elementsToExport = [
                { id: 'adaptive-result', title: '適應型風格' },
                { id: 'affect-regulating-result', title: '情感調節型風格' },
                { id: 'image-distorting-result', title: '影像扭曲型風格' }
            ];

            for (const elementInfo of elementsToExport) {
                const element = document.getElementById(elementInfo.id);
                pdf.addPage();
                const canvas = await html2canvas(element, { scale: 3, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min((pdfWidth - margin * 2) / imgWidth, (pdfHeight - margin * 2) / imgHeight);
                const imgFinalWidth = imgWidth * ratio;
                const imgFinalHeight = imgHeight * ratio;
                const x = (pdfWidth - imgFinalWidth) / 2;
                const y = (pdfHeight - imgFinalHeight) / 2;
                pdf.addImage(imgData, 'PNG', x, y, imgFinalWidth, imgFinalHeight);
            }

            pdf.save('DSQ-60_多頁報告.pdf');
        });

        // --- UPDATED: HTML Export Logic (with detailed answers) ---
        document.getElementById('export-html-btn').addEventListener('click', () => {
            const name = document.getElementById('name').value || '未提供';
            const date = new Date().toLocaleString('zh-TW', { hour12: false });

            const adaptiveChartImg = charts.adaptive.toBase64Image();
            const affectChartImg = charts.affectRegulating.toBase64Image();
            const imageChartImg = charts.imageDistorting.toBase64Image();

            const adaptiveScore = document.getElementById('adaptive-style-score').textContent;
            const affectScore = document.getElementById('affect-regulating-style-score').textContent;
            const imageScore = document.getElementById('image-distorting-style-score').textContent;
            
            // --- NEW: Create a reverse map from question number to defense mechanism ---
            const qNumToDefenseMap = {};
            for (const defenseName in questionMapping) {
                questionMapping[defenseName].items.forEach(qNum => {
                    qNumToDefenseMap[qNum] = defenseName;
                });
            }

            // --- NEW: Generate HTML for the detailed answers table ---
            let answerRowsHtml = '';
            for (let i = 1; i <= questions.length; i++) {
                const question = questions.find(q => q.qNum === i);
                const answer = document.querySelector(`input[name="q${i}"]:checked`).value;
                const defense = qNumToDefenseMap[i];
                answerRowsHtml += `
                    <tr>
                        <td>${question.qNum}</td>
                        <td>${question.text}</td>
                        <td>${defense}</td>
                        <td>${answer}</td>
                    </tr>
                `;
            }

            let cssText = '';
            for (let sheet of document.styleSheets) {
                try {
                    for (let rule of sheet.cssRules) { cssText += rule.cssText; }
                } catch (e) { console.warn("Could not read CSS rule:", e); }
            }

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="zh-Hant">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>DSQ-60 結果報告 - ${name}</title>
                    <style>${cssText}</style>
                    <style> 
                        body { padding: 20px; } 
                        .export-buttons, #questionnaire-form, .modal, #pdf-cover-page { display: none !important; }
                        #results { display: block !important; border-top: none; margin-top: 0; padding-top: 0; }
                        .answers-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
                        .answers-table th, .answers-table td { border: 1px solid #dee2e6; padding: 8px 12px; text-align: left; }
                        .answers-table th { background-color: #f8f9fa; font-weight: bold; }
                        .answers-table tr:nth-child(even) { background-color: #fdfdfd; }
                        .answers-table td:nth-child(1), .answers-table td:nth-child(4) { text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>DSQ-60 結果報告</h1>
                        <p><strong>姓名:</strong> ${name}</p>
                        <p><strong>完成日期:</strong> ${date}</p>
                        <hr>

                        <!-- NEW: Detailed Answers Section -->
                        <div id="detailed-answers">
                            <h2>問卷作答詳情</h2>
                            <table class="answers-table">
                                <thead>
                                    <tr>
                                        <th style="width: 5%;">題號</th>
                                        <th style="width: 55%;">題目內容</th>
                                        <th style="width: 25%;">對應防衛機制</th>
                                        <th style="width: 15%;">你的回答 (1-7)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${answerRowsHtml}
                                </tbody>
                            </table>
                        </div>
                        <hr style="margin: 30px 0;">

                        <!-- Summary Results Section -->
                        <div id="results">
                            <h2>結果總覽</h2>
                            <div class="result-style">
                                <h3>適應型風格 (Adaptive Style)</h3>
                                <p>此風格反映出健康、成熟及具建設性的方式來應對壓力、衝突和困難情緒...</p>
                                <p class="style-score">${adaptiveScore}</p>
                                <div class="chart-container"><img src="${adaptiveChartImg}" style="width:100%; height:auto;"></div>
                            </div>
                            <div class="result-style">
                                <h3>情感調節型風格 (Affect-Regulating Style)</h3>
                                <p>此風格透過將困擾的情緒排除在意識之外來進行管理...</p>
                                <p class="style-score">${affectScore}</p>
                                <div class="chart-container"><img src="${affectChartImg}" style="width:100%; height:auto;"></div>
                            </div>
                            <div class="result-style">
                                <h3>影像扭曲型風格 (Image-Distorting Style)</h3>
                                <p>此風格透過扭曲對自己或他人的看法來處理內心困擾...</p>
                                <p class="style-score">${imageScore}</p>
                                <div class="chart-container"><img src="${imageChartImg}" style="width:100%; height:auto;"></div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'DSQ-60_完整報告.html';
            a.click();
            URL.revokeObjectURL(a.href);
        });
    </script>


</body></html>
